name: Rotate Apple OAuth Secret

# Runs every 5 months (before the 6-month expiry)
on:
  schedule:
    # At 00:00 on the 1st of January, June (every ~5 months)
    - cron: '0 0 1 1,6 *'
  workflow_dispatch: # Allow manual trigger

jobs:
  rotate-secret:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Apple Client Secret
        id: generate
        run: |
          # Create the JWT header and payload
          HEADER=$(echo -n '{"alg":"ES256","kid":"${{ secrets.APPLE_KEY_ID }}","typ":"JWT"}' | base64 -w 0 | tr '+/' '-_' | tr -d '=')
          
          NOW=$(date +%s)
          EXP=$((NOW + 15552000)) # 180 days
          PAYLOAD=$(echo -n '{"iss":"${{ secrets.APPLE_TEAM_ID }}","iat":'$NOW',"exp":'$EXP',"aud":"https://appleid.apple.com","sub":"${{ secrets.APPLE_CLIENT_ID }}"}' | base64 -w 0 | tr '+/' '-_' | tr -d '=')
          
          # Sign with the private key
          SIGNATURE=$(echo -n "${HEADER}.${PAYLOAD}" | openssl dgst -sha256 -sign <(echo "${{ secrets.APPLE_PRIVATE_KEY }}") | base64 -w 0 | tr '+/' '-_' | tr -d '=')
          
          SECRET="${HEADER}.${PAYLOAD}.${SIGNATURE}"
          echo "secret=$SECRET" >> $GITHUB_OUTPUT
          echo "::add-mask::$SECRET"

      - name: Update Supabase Apple Provider
        run: |
          curl -X PATCH \
            "https://api.supabase.com/v1/projects/${{ secrets.SUPABASE_PROJECT_REF }}/config/auth" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ACCESS_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "external_apple_enabled": true,
              "external_apple_client_id": "${{ secrets.APPLE_CLIENT_ID }}",
              "external_apple_secret": "${{ steps.generate.outputs.secret }}"
            }'

      - name: Notify on success
        if: success()
        run: |
          echo "✅ Apple OAuth secret rotated successfully!"
          echo "New secret expires in 180 days."

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Failed to rotate Apple OAuth secret!"
          echo "Manual intervention required."

